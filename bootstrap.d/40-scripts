#!/usr/bin/env bash
set -euo pipefail

ROOT="$(dirname ${BASH_SOURCE[0]})"
SCRIPT_DIR="$ROOT/scripts"
XDG_BIN_HOME="${XDG_BIN_HOME:-$HOME/.local/bin}"

log() { printf "\033[1;36m[40-scripts]\033[0m %s\n" "$*"; }

mkdir -p "$XDG_BIN_HOME"

log "Linking scripts to $XDG_BIN_HOME"
linked_count=0
skipped_count=0

for script in "$SCRIPT_DIR"/*; do
    [ -f "$script" ] || continue
    script_name=$(basename "$script")
    target="$XDG_BIN_HOME/$script_name"

    if [ -L "$target" ] && [ "$(readlink "$target")" = "$script" ]; then
        log "Script $script_name already linked correctly"
        skipped_count=$((skipped_count + 1))
    else
        log "Linking $script_name"
	ln -sfn -- "$(realpath $script)" "$target"
        linked_count=$((linked_count + 1))
    fi
done

# Clean up any broken symlinks that may have been left from previous runs
find "$XDG_BIN_HOME" -type l ! -exec test -e {} \; -delete 2>/dev/null || true

log "[40-scripts] OK - Linked: $linked_count, Skipped: $skipped_count"

exit 0

